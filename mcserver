#!/usr/bin/env python3
from pathlib import Path
import argparse
import json
import logging as log
import os
import requests
import sys
import textwrap

# RAM size in MebiByte
default_configs = {
  "modrinth": {
    "search_limit": 20
  },
  "server": {
    "jarfile": "Launcher.jar",
    "ram": {
      "min": 512,
      "max": 2_048
    },
    "hide_gui": True,

    "version": "1.21.11",
    "software": {
      "loader": "fabric"
    }
  }
}

# Paths
mcserver_dir = Path(".mcserver")
configs_dir = mcserver_dir / "configs"

# Color functions
colors = {
  "bold": "\033[1m",
  "gray": "\033[90m",
  "green": "\033[92m",
  "red": "\033[91m",
  "reset": "\033[0m",
  "yellow": "\033[93m"
}

def color(color_name):
  if sys.stdout.isatty() and sys.stderr.isatty():
    return colors[color_name]
  else:
    return ""

def mod_environment_color(environment):
  if environment == "required":
    return f"{color('green')}Required{color('reset')}"

  elif environment == "optional":
    return f"{color('yellow')}Optional{color('reset')}"

  elif environment == "unsupported":
    return f"{color('red')}Unsupported{color('reset')}"

  elif environment == "unknown":
    return f"{color('gray')}Unknown{color('reset')}"

# Config functions
def generate_config(config_name):
  config_filename = f"{config_name}.json"
  config_path = configs_dir / config_filename

  with open(config_path, mode="xt") as config_file:
    json.dump(
      default_configs[config_name],
      config_file,
      indent=2
    )

def load_config(config_name):
  config_filename = f"{config_name}.json"
  config_path = configs_dir / config_filename

  try:
    with open(config_path, mode="rt") as config_file:
      return json.load(config_file)
  except json.JSONDecodeError as error:
    msg = error.msg.lower()
    lineno = error.lineno
    colno = error.colno

    raise ValueError(f"Failed to parse configuration file '{config_path}': {msg} at line {lineno} column {colno}")
  except Exception as error:
    raise error

# Command functions
def initialize_directory(args):
  if not mcserver_dir.exists():
    log.info(f"Initializing MCServer directory at {mcserver_dir.resolve()}")
  else:
    log.info(f"Reinitializing MCServer directory at {mcserver_dir.resolve()}")

  mcserver_dir.mkdir(exist_ok=True)
  configs_dir.mkdir(exist_ok=True)

  # TODO: make this config just iterate the default_config's key so it generates every config automatically
  generate_config("modrinth")
  generate_config("server")

def search_mod(args):
  query = " ".join(args.query)
  offset = args.page

  modrinth_config = load_config("modrinth")
  server_config = load_config("server")

  search_limit = modrinth_config["search_limit"]
  search_offset = search_limit * (offset - 1)

  server_software = server_config["software"]

  search_filters = json.dumps([
    ["project_type:mod"],
    ["server_side!=unsupported"],
    [f"categories:{server_software['loader']}"],
    [f"versions:{server_config['version']}"]])

  log.info("Searching mods in Modrinth...")
  response = requests.get(
    "https://api.modrinth.com/v2/search",
    params={
      "query": query,
      "facets": search_filters,
      "limit": search_limit,
      "offset": search_offset
    },

    headers={
      "User-Agent": "othecat35/MCServer"
    }
  )

  response.raise_for_status()
  response_json = response.json()
  mods_list = response_json.get("hits", [])

  if not mods_list:
    raise Warning("Couldn't find any mod (only showing mods with server environment)")

  total_hits = response_json.get("total_hits", 0)
  shown_mods_count = len(mods_list) if len(mods_list) < search_limit else search_limit
  log.info(f"Showing {shown_mods_count} out of {total_hits} mods (skipping the first {search_offset} mods):")
  for mod in mods_list:
    title = f"{color('bold')}{mod['title']}{color('reset')}"
    slug = mod['slug']

    author = mod['author']

    server_side = mod_environment_color(mod['server_side'])
    client_side = mod_environment_color(mod["client_side"])

    description = textwrap.shorten(mod["description"], width=120, placeholder="...")

    print(f"""
{title} ({slug}) {color("gray")}by {author}{color('reset')}
> https://modrinth.com/mod/{slug}
> {color('bold')}Server: {server_side}{color('reset')} | Client: {client_side}
  {description}""")

def start_server(args):
  server_config = load_config("server")
  memory_limit = server_config["ram"]

  jarfile = server_config['jarfile']

  if memory_limit["min"] > memory_limit["max"]:
    raise ValueError("Minimum RAM cannot be larger that maximum RAM")

  if not Path(jarfile).exists():
    raise FileNotFoundError(f"Couldn't find server jarfile '{jarfile}'")

  java_command_argv = [
    "java",
    f"-Xms{memory_limit['min']}M",
    f"-Xmx{memory_limit['max']}M",
    "-jar",
    server_config["jarfile"]
  ]

  if server_config["hide_gui"]:
    java_command_argv.append("nogui")

  log.info("Starting Minecraft server...")
  log.debug(f"Executing command: {" ".join(java_command_argv)}")
  os.execvp("java", java_command_argv)

# Main
def main():
  log_level = log.DEBUG if os.getenv("MCSERVER_DEBUG") == "1" else log.INFO

  log.basicConfig(
    format="[%(levelname)s]: %(message)s",
    level=log_level
  )

  parser = argparse.ArgumentParser()
  subparsers = parser.add_subparsers(required=True)

  parser_init = subparsers.add_parser("init", help="initialize MCServer directory")
  parser_init.set_defaults(func=initialize_directory)

  parser_search = subparsers.add_parser("search", help="search mods from Modrinth")
  parser_search.add_argument("query", help="search query", nargs="+")
  parser_search.add_argument("--page", help="page number of the search results", type=int, default=1)
  parser_search.set_defaults(func=search_mod)

  parser_start = subparsers.add_parser("start", help="start the server")
  parser_start.set_defaults(func=start_server)

  args = parser.parse_args()

  try:
    args.func(args)
  except Exception as error:
    log.error(error)

if __name__ == "__main__": main()
