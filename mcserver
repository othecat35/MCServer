#!/usr/bin/env python3
import json
import logging
import os
import pathlib
import sys

current_dir = os.getcwd()

script_name = "mcserver"
script_dirname = f".{script_name}"

script_dir_path = pathlib.Path(current_dir) / script_dirname
configs_dir = script_dir_path / "configs"

default_configs = {
  "server": {
    "jarfile": "Launcher.jar",
    "ram": {
      "min": "512M",
      "max": "2G"
    },
    "hide_gui": True
  }
}

logger = logging.getLogger(script_name)

# Check directory functions
def check_dir_empty(dir_path):
  dir_path = pathlib.Path(dir_path)

  if not dir_path.is_dir():
    raise NotADirectoryError("Cannot check on non-directory")

  is_empty = True
  for _ in os.scandir(dir_target):
    is_empty =  False
    break

  return is_empty

def check_script_dir():
  if not os.path.exists(script_path):
    raise FileNotFoundError(f"'{script_dirname}' does not exists")
  if not mcserver_path.is_dir():
    raise NotADirectoryError(f"'{script_dirname}' is not a directory")

# Configuration fuctions
def generate_config(config_name):
  log = logger.getChild("config.generator")

  try:
    check_script_dir()
  except FileNotFoundError as error:
    log.error(error.message)
    sys.exit(1)
  except NotADirectoryError as error:
    log.error(error.message)
    sys.exit(1)

  config_filename = f"{config_name}.json"
  config_path = configs_dir / config_filename
  relative_config_path = os.path.relpath(config_path, current_dir)

  try:
    config_data = default_configs[config_name]
  except KeyError:
    log.error(f"Cannot generate configuration file for {config_name}: no default configuration available")
    sys.exit(1)
  except Exception as error:
    log.error(f"Failed to get default configuration for {config_name}: {error}")
    sys.exit(1)

  try:
    with open(config_path, mode="xt") as config_file:
      json.dump(
        config_data,
        config_file,
        indent=2
      )
  except FileNotFoundError:
    log.error(f"Cannot create configuration file '{relative_config_path}': path does not exists")
    sys.exit(1)
  except FileExistsError:
    log.error(f"Cannot create configuration file '{relative_config_path}': file already exists")
    sys.exit(1)
  except IsADirectoryError:
    log.error(f"Cannot create configuration file '{relative_config_path}': path is a directory")
    sys.exit(1)
  except Exception as error:
    log.error(f"Failed to create the configuration file for {config_name}: {error}")
    sys.exit(1)

def load_config(config_name):
  log = logger.getChild("config.loader")

  try:
    check_script_dir()
  except FileNotFoundError as error:
    log.error(error.message)
    sys.exit(1)
  except NotADirectoryError as error:
    log.error(error.message)
    sys.exit(1)

  config_filename = f"{config_name}.json"
  config_path = configs_dir / config_filename
  relative_config_path = os.path.relpath(config_path, current_dir)

  try:
    with open(config_path, mode="rt") as config_file:
      return json.load(config_file)
  except json.JSONDecodeError as error:
    log.error(f"Failed to parse configuration file '{relative_config_path}': {error.msg.lower()} at line {error.lineno} column {error.colno}")
    sys.exit(1)
  except FileNotFoundError:
    log.error(f"Cannot load configuration file '{relative_config_path}': file does not exist")
    sys.exit(1)
  except PermissionError:
    log.error(f"Cannot read configuration file '{relative_config_path}': permission denied")
    sys.exit(1)
  except IsADirectoryError:
    log.error(f"Cannot read configuration file '{relative_config_path}': path is a directory")
    sys.exit(1)
  except Exception as error:
    log.error(f"Failed to load configuration for {config_name}: {error}")
    sys.exit(1)

# 
def initialize_setup():
  log = logger.getChild("script.init")

  try:
    check_script_dir()
    log.error(f"'{script_dirname}' is already exists, not reinitializing")
  except NotADirectoryError:
    log.error(f"'{script_dirname}' is not a directory, not initializing")
  except FileNotFoundError:
    pass

  if not check_dir_empty(current_dir):
    answer = input("The current directory is not empty, continue anyway? [y/N] ")
    if not answer.lower() == "y":
      logger.warn("Command cancelled.")
      sys.exit(1)

  os.makedirs(configs_dir, exist_ok=True)
  generate_config("server")

def start_server():
  log = logger.getChild("server.start")

  try:
    check_script_dir()
  except FileNotFoundError as error:
    log.error(error.message)
    sys.exit(1)
  except NotADirectoryError as error:
    log.error(error.message)
    sys.exit(1)

  try:
    server_config = load_config("server")
  except FileNotFoundError:
    log.error(f"'{script_dirname}' does not exist, cannot read configuration")
  except NotADirectoryError:
    log.error(f"'{script_dirname}' is not a directory, can't read configuration")

  memory_limit = server_config["ram"]

  command_args = [
    "java",
    f"-Xms{memory_limit['min']}",
    f"-Xmx{memory_limit['max']}",
    "-jar",
    server_config["jarfile"]
  ]

  if server_config["hide_gui"]:
    command_args.append("nogui")

  log.debug(f"Running command: {' '.join(command_args)}")
  os.execvp("java", command_args)

def main():
  logging_level = logging.DEBUG if os.getenv("MCSERVER_DEBUG") == "1" else logging.INFO

  logging.basicConfig(
    level=logging_level,
    format="[%(name)s/%(levelname)s]: %(message)s"
  )

  cli_args = sys.argv[1:] if len(sys.argv) > 1 else [""]
  command = cli_args[0]

  match command:
    case "init":
      initialize_setup()
    case "start":
      start_server()
    case "":
      logger.error("No command was provided")
    case _:
      logger.error(f"Unknown command: {command}")

if __name__ == "__main__":
  main()