#!/usr/bin/env python3
import json
import logging as log
import os
import requests
import sys
import textwrap

# RAM size in MebiByte
configs = {
  "server": {
    "jarfile": "Launcher.jar",
    "ram": {
      "min": 512,
      "max": 2_048
    },
    "hide_gui": True,

    "version": "1.20.2",
    "software": {
      "loader": "fabric"
    }
  }
}

# Color functions
colors = {
  "bold": "\033[1m",
  "gray": "\033[90m",
  "green": "\033[92m",
  "red": "\033[91m",
  "reset": "\033[0m",
  "yellow": "\033[93m"
}

def color(color_name):
  if sys.stdout.isatty() and sys.stderr.isatty():
    return colors[color_name]
  return ""

def mod_environment_color(environment):
  if environment == "required":
    return f"{color('green')}Required{color('reset')}"

  elif environment == "optional":
    return f"{color('yellow')}Optional{color('reset')}"

  elif environment == "unsupported":
    return f"{color('red')}Unsupported{color('reset')}"

  elif environment == "unknown":
    return f"{color('gray')}Unknown{color('reset')}"

# Command functions
def search_mod(query):
  server_config = configs["server"]
  server_software = server_config["software"]

  search_filters = json.dumps([
    ["project_type:mod"],
    ["server_side:required","server_side:optional"],
    [f"categories:{server_software['loader']}"],
    [f"versions:{server_config['version']}"]])

  log.info("Searching mods in Modrinth...")
  response = requests.get(
    "https://api.modrinth.com/v2/search",
    params={
      "query": query,
      "facets": search_filters,
      "limit": 20
    },

    headers={
      "User-Agent": "othecat35/MCServer "
    }
  )

  response.raise_for_status()
  mods_list = response.json().get("hits", [])

  if not mods_list:
    raise Warning("Couldn't find any mod (only showing mods with server environment)")

  for mod in mods_list:
    title = f"{color('bold')}{mod['title']}{color('reset')}"
    slug = mod['slug']

    author = mod['author']

    server_side = mod_environment_color(mod['server_side'])
    client_side = mod_environment_color(mod["client_side"])

    description = textwrap.shorten(mod["description"], width=120, placeholder="...")

    print(f"""
{title} ({slug}) {color("gray")}by {author}{color('reset')}
> {color('bold')}Server: {server_side}{color('reset')} | Client: {client_side}
  {description}""")

def start_server():
  server_config = configs["server"]
  memory_limit = server_config["ram"]

  java_command_argv = [
    "java",
    f"-Xms{memory_limit['min']}M",
    f"-Xmx{memory_limit['max']}M",
    "-jar",
    server_config["jarfile"]
  ]

  if server_config["hide_gui"]:
    java_command_argv.append("nogui")

  log.info("Starting Minecraft server...")
  log.debug(f"Executing command: {" ".join(java_command_argv)}")
  os.execvp("java", java_command_argv)

# Main
def main():
  log.basicConfig(
    format="[%(levelname)s]: %(message)s",
    level=log.INFO
  )

  script_args = sys.argv[1:] if len(sys.argv) > 1 else [""]
  command = script_args[0]

  try:
    match command:
      case "search":
        search_mod(" ".join(script_args[1:]))
      case "start":
        start_server()
      case "":
        log.error("No command was provided")
      case _:
        log.error(f"Unknown command: {command}")
  except Warning as error:
    log.warning(error)
    sys.exit(1)
  except Exception as error:
    log.error(error)
    sys.exit(1)

if __name__ == "__main__": main()
