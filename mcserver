#!/usr/bin/env python3
import json
import logging
import os
import pathlib
import sys

logger = logging.getLogger("mcserver")
cwd = os.getcwd()

default_configs = {
  "server": {
    "jarfile": "Launcher.jar",
    "ram": {
      "min": "512M",
      "max": "2G"
    },
    "hide_gui": True
  }
}

def generate_config(config_name):
  config_filename = f"{config_name.lower()}.json"
  configs_dir = pathlib.Path(cwd) / ".mcserver" / "configs"

  config_path = configs_dir / config_filename
  relative_config_path = os.path.relpath(config_path, cwd)

  log = logger.getChild("config.generate")

  try:
    with open(config_path, mode="xt") as config_file:
      config_content = json.dumps(
        default_configs[config_name],
        indent=2
      )

      config_file.write(config_content)
  except FileExistsError:
    log.error(f"Cannot create configuration file {relative_config_path}, file already exists!")
  except IsADirectoryError:
    log.error(f"Cannot create configuration file {relative_config_path}, is a directory!")
    sys.exit(1)

def load_config(config_name):
  config_filename = f"{config_name.lower()}.json"
  configs_dir = pathlib.Path(cwd) / ".mcserver" / "configs"

  config_path = configs_dir / config_filename
  relative_config_path = os.path.relpath(config_path, cwd)

  log = logger.getChild("config.load")

  try:
    with open(config_path, mode="rt") as config_file:
      return json.load(config_file)
  except json.JSONDecodeError as error:
    log.error(f"Failed to parse configuration file {relative_config_path}, {error.msg.lower()} at line {error.lineno} column {error.colno}!")
    sys.exit(1)
  except FileNotFoundError:
    log.error(f"Cannot read configuration file {relative_config_path}, file does not exist!")
    sys.exit(1)
  except PermissionError:
    log.error(f"Cannot read configuration file {relative_config_path}, not enough permission!")
    sys.exit(1)
  except IsADirectoryError:
    log.error(f"Cannot read configuration file {relative_config_path}, is a directory!")
    sys.exit(1)

def start_server():
  log = logger.getChild("server.start")

  server_config = load_config("server")
  ram_limit = server_config["ram"]

  command_args = [
    "java",
    f"-Xms{ram_limit['min']}",
    f"-Xmx{ram_limit['max']}",
    "-jar",
    server_config["jarfile"]
  ]

  if server_config["hide_gui"]:
    command_args.append("nogui")

  log.debug(f"Running command: {' '.join(command_args)}")
  os.execvp("java", command_args)

def main():
  logging.basicConfig(
    level=logging.INFO,
    format="[%(name)s/%(levelname)s]: %(message)s"
  )

  cli_args = sys.argv[1:] if len(sys.argv) > 1 else [""]
  command = cli_args[0]

  match command:
    case "start":
      start_server()
    case "":
      logger.error("No command was provided")
    case _:
      logger.error(f"Unknown command: {command}")

if __name__ == "__main__":
  main()